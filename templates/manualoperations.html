<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Smart Coffee</title>

  <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body class="container-fluid py-4">

  {% include 'sidenavigation.html' %}

  <h1 class="mb-4 text-center">☕ Contrôle Manuel – Smart Coffee</h1>

  <div class="card mb-4">
    <div class="card-header bg-primary text-white">
      <i class="bi bi-thermometer-half"></i> Températures & PID
    </div>
    <div class="card-body">
      <p><strong>Température actuelle :</strong> <span id="currentTemp">--</span></p>
      <p><strong>Température cible :</strong> <span id="setTemp">--</span></p>
      <p><strong>Commande P :</strong> <span id="commandP">--</span></p>
      <p><strong>Commande I :</strong> <span id="commandI">--</span></p>
      <p><strong>Commande D :</strong> <span id="commandD">--</span></p>
      <p><strong>Temps de brassage restant :</strong> <span id="brewTime">--</span></p>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-header bg-warning text-dark">
      <i class="bi bi-graph-up"></i> Température & PWM en temps réel
    </div>
    <div class="card-body">
      <canvas id="tempChart" height="150"></canvas>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-header bg-info text-white">
      <i class="bi bi-sliders"></i> Réglage de la température cible
    </div>
    <div class="card-body">
      <label for="targetTemp" class="form-label">Température :</label>
      <div class="d-flex align-items-center">
        <input type="range" class="form-range me-3" min="90" max="130" value="98"
               id="targetTemp" oninput="rangeValue.value=targetTemp.value">
        <output id="rangeValue">98</output> °C
      </div>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-header bg-secondary text-white">
      <i class="bi bi-cpu"></i> Commandes
    </div>
    <div class="card-body text-center">
      <div class="btn-group mb-3" role="group">
        <button id="brewButton" class="btn btn-success">
          <i class="bi bi-cup-hot"></i> Brew 20 sec
        </button>
        <button id="purgeButton" class="btn btn-danger">
          <i class="bi bi-x-circle"></i> Purge 1 sec
        </button>
      </div>
      <br>
      <div class="btn-group" role="group">
        <button id="temp975Button" class="btn btn-outline-primary">
          <i class="bi bi-arrow-down"></i> Temp 97.5 °C
        </button>
        <button id="temp110Button" class="btn btn-outline-primary">
          <i class="bi bi-arrow-up"></i> Temp 110 °C
        </button>
      </div>
    </div>
  </div>

  <script type="text/javascript">
    $(function () {
      $('#brewButton').click(() => $.getJSON('/_brew'));
      $('#purgeButton').click(() => $.getJSON('/_purge'));
      $('#temp975Button').click(() => $.getJSON('/_setTemp975'));
      $('#temp110Button').click(() => $.getJSON('/_setTemp110'));
    });

    let tempData = [];
    let pwmData = [];
    let labels = [];
    const maxPoints = 50;

    const ctx = document.getElementById('tempChart').getContext('2d');
    const tempChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [
          {
            label: 'Température de l’eau (°C)',
            data: tempData,
            borderColor: '#0dcaf0',
            backgroundColor: 'rgba(13, 202, 240, 0.1)',
            tension: 0.3,
            pointRadius: 0,
            yAxisID: 'y'
          },
          {
            label: 'PWM (%)',
            data: pwmData,
            borderColor: '#ffc107',
            backgroundColor: 'rgba(255, 193, 7, 0.1)',
            tension: 0.3,
            pointRadius: 0,
            yAxisID: 'y1'
          }
        ]
      },
      options: {
        scales: {
          y: {
            type: 'linear',
            position: 'left',
            suggestedMin: 80,
            suggestedMax: 120,
            title: { display: true, text: 'Température (°C)' },
            ticks: { color: '#0dcaf0' }
          },
          y1: {
            type: 'linear',
            position: 'right',
            suggestedMin: 0,
            suggestedMax: 100,
            title: { display: true, text: 'PWM (%)' },
            grid: { drawOnChartArea: false },
            ticks: { color: '#ffc107' }
          },
          x: { display: false }
        },
        responsive: true,
        animation: false,
        plugins: {
          legend: {
            labels: { color: '#fff' }
          }
        }
      }
    });

    function updateStatus() {
      $.getJSON('/_get_temp', function (data) {
        const now = new Date().toLocaleTimeString();
        const temp = data.temp;
        const pwm = data.commandPWM;

        $("#currentTemp").text(temp + " °C");
        $("#setTemp").text(data.setTemp + " °C");
        $("#commandP").text(data.commandP);
        $("#commandI").text(data.commandI);
        $("#commandD").text(data.commandD);
        $("#brewTime").text(data.brew + " sec");

        if (temp !== undefined && pwm !== undefined) {
          tempData.push(temp);
          pwmData.push(pwm);
          labels.push(now);

          if (tempData.length > maxPoints) {
            tempData.shift();
            pwmData.shift();
            labels.shift();
          }

          tempChart.update();
        }
      });
    }

    setInterval(updateStatus, 1000);
  </script>

</body>
</html>
